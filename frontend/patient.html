<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - DentalCare</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="glass" style="position: sticky; top: 0; z-index: 100;">
        <nav class="container"
            style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
            <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--primary); cursor: pointer;"
                onclick="location.href='index.html'">Patient<span style="color: var(--accent);">Portal</span></h1>
            <button class="menu-toggle" id="mobile-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" style="display: flex; gap: 1.5rem; align-items: center;">
                <a href="index.html" style="text-decoration: none; color: var(--text); font-weight: 500;">Home</a>
                <a href="index.html#services"
                    style="text-decoration: none; color: var(--text); font-weight: 500;">Services</a>
                <a href="about.html" style="text-decoration: none; color: var(--text); font-weight: 500;">About</a>
                <a href="contact.html" style="text-decoration: none; color: var(--text); font-weight: 500;">Contact</a>
                <span id="user-name" style="font-weight: 600; font-size: 0.9rem;"></span>
                <button onclick="logout()" class="btn btn-outline"
                    style="padding: 0.5rem 1rem; font-size: 0.85rem;">Logout</button>
            </div>
        </nav>
    </header>

    <main class="container" style="padding: 3rem 0;">
        <div class="fade-in"
            style="margin-bottom: 3rem; display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h2 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Welcome back, <span class="text-gradient"
                        id="welcome-name">Patient</span></h2>
                <p style="color: var(--text-muted);">Manage your oral health and book new appointments.</p>
            </div>
            <a href="#book-section" class="btn btn-primary">New Appointment</a>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 380px; gap: 3rem;">
            <!-- Upcoming Appointments -->
            <div>
                <h3 style="margin-bottom: 2rem; font-size: 1.5rem;">Your Appointments</h3>
                <div id="appointments-list" class="grid" style="grid-template-columns: 1fr; gap: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 4rem;">Loading appointments...</div>
                </div>
            </div>

            <!-- Booking Section -->
            <div id="book-section">
                <div class="card glass"
                    style="position: sticky; top: 100px; padding: 2.5rem; border: none; background: rgba(255,255,255,0.9);">
                    <h3 style="margin-bottom: 2rem; font-size: 1.5rem; text-align: center;">Book a Visit</h3>
                    <form id="book-form">
                        <div class="form-group">
                            <label class="form-label">Select Specialist</label>
                            <select id="dentist-select" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Service Type</label>
                            <select id="service-select" class="form-control" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preffered Date & Time</label>
                            <input type="datetime-local" id="datetime" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Notes</label>
                            <textarea id="notes" class="form-control" rows="3"
                                placeholder="Any specific concerns?"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Confirm
                            Booking</button>
                    </form>
                    <div id="book-error"
                        style="color: var(--danger); margin-top: 1.5rem; text-align: center; font-size: 0.9rem; font-weight: 500; display: none; padding: 1rem; background: #fee2e2; border-radius: 8px;">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer style="padding: 5rem 0; background: #0f172a; color: white; margin-top: 4rem;">
        <div class="container" style="text-align: center;">
            <p style="color: #64748b; font-size: 0.9rem;">&copy; 2026 DentalCare Clinic. Developed by Jiban Chaudhary.
                All rights reserved.</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'patient') {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('welcome-name').textContent = user.name.split(' ')[0];
            loadData();
        });

        async function loadData() {
            try {
                // Load Dentists
                const dentistsRes = await fetchAPI('/dentists');
                document.getElementById('dentist-select').innerHTML = dentistsRes.data.map(d => `
                    <option value="${d.id}">${d.user.name} - ${d.specialization}</option>
                `).join('');

                // Load Services
                const servicesRes = await fetchAPI('/services');
                document.getElementById('service-select').innerHTML = servicesRes.data.map(s => `
                    <option value="${s.id}">${s.name} (Rs. ${s.price})</option>
                `).join('');

                // Load Appointments
                const apptRes = await fetchAPI('/appointments');
                const list = document.getElementById('appointments-list');
                if (apptRes.data.length === 0) {
                    list.innerHTML = '<div class="card" style="text-align: center; padding: 4rem; color: var(--text-muted);">No upcoming appointments yet.</div>';
                } else {
                    list.innerHTML = apptRes.data.map(a => `
                        <div class="card fade-in" style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1.5rem;">
                                <div style="width: 50px; height: 50px; background: rgba(37, 99, 235, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem;">ðŸ“…</div>
                                <div>
                                    <h4 style="font-size: 1.1rem; margin-bottom: 0.25rem;">${a.service.name}</h4>
                                    <p style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">${new Date(a.appointmentTime).toLocaleString()}</p>
                                    <p style="font-size: 0.85rem; margin-top: 0.25rem;">With <span style="color: var(--primary); font-weight: 600;">Dr. ${a.dentist.user.name}</span></p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span class="status-badge status-${a.status}" style="margin-bottom: 0.75rem; display: inline-block;">${a.status}</span>
                                <br>
                                ${a.status !== 'cancelled' ? `
                                    <button onclick="cancelAppt(${a.id})" style="color: var(--danger); background: none; border: none; font-weight: 700; cursor: pointer; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">Cancel Visit</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function cancelAppt(id) {
            if (!confirm('Are you sure you want to cancel this appointment?')) return;
            try {
                await fetchAPI(`/appointments/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'cancelled' })
                });
                showToast('Appointment cancelled successfully', 'success');
                loadData();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        document.getElementById('book-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('book-error');
            errorDiv.style.display = 'none';

            const dentistId = document.getElementById('dentist-select').value;
            const serviceId = document.getElementById('service-select').value;
            const appointmentTime = document.getElementById('datetime').value;
            const notes = document.getElementById('notes').value;

            if (!dentistId || !serviceId || !appointmentTime) {
                errorDiv.textContent = 'Please fill in all required fields.';
                errorDiv.style.display = 'block';
                return;
            }

            const selectedDate = new Date(appointmentTime);
            const now = new Date();

            // 1. Future date validation
            if (selectedDate <= now) {
                errorDiv.textContent = 'Please select a future date and time.';
                errorDiv.style.display = 'block';
                return;
            }

            // 2. Clinic hours validation (9:00 AM - 5:00 PM)
            const hours = selectedDate.getHours();
            if (hours < 9 || hours >= 17) {
                errorDiv.textContent = 'Appointments are only available between 9:00 AM and 5:00 PM.';
                errorDiv.style.display = 'block';
                return;
            }

            // 3. Weekend check (Closed on Saturdays)
            if (selectedDate.getDay() === 6) { // 6 is Saturday
                errorDiv.textContent = 'Sorry, the clinic is closed on Saturdays.';
                errorDiv.style.display = 'block';
                return;
            }

            const payload = { dentistId, serviceId, appointmentTime, notes };

            try {
                await fetchAPI('/appointments', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showToast('Appointment booked successfully!', 'success');
                loadData();
                e.target.reset();
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
            }
        });

        function setupMobileMenu() {
            const toggle = document.getElementById('mobile-menu');
            const nav = document.querySelector('.nav-links');
            if (toggle && nav) {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    nav.classList.toggle('active');
                });
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', setupMobileMenu);
    </script>
</body>

</html>